--laboratorio 08

CREATE DATABASE bd_laboratorio08

USE bd_laboratorio08

DROP TABLE TB_SOLICITACAO
DROP TABLE TB_TECNICO
DROP TABLE TB_FUNCIONARIO
DROP TABLE TB_SETOR
DROP TABLE TB_DEPARTAMENTO


CREATE TABLE TB_DEPARTAMENTO (
  CD_DEPARTAMENTO INT NOT NULL PRIMARY KEY,
  NM_DEPARTAMENTO VARCHAR(40) NOT NULL
)

INSERT INTO TB_DEPARTAMENTO (CD_DEPARTAMENTO, NM_DEPARTAMENTO)
VALUES (10,'TI')

INSERT INTO TB_DEPARTAMENTO (CD_DEPARTAMENTO, NM_DEPARTAMENTO)
VALUES (20,'RH')

INSERT INTO TB_DEPARTAMENTO (CD_DEPARTAMENTO, NM_DEPARTAMENTO)
VALUES (30,'MA')



CREATE TABLE TB_SETOR (
  CD_SETOR INT NOT NULL PRIMARY KEY,
  NM_SETOR VARCHAR(40) NOT NULL,
  NM_GERENTE VARCHAR(50) NOT NULL,
  CD_DEPARTAMENTO INT NOT NULL
)

ALTER TABLE TB_SETOR ADD CONSTRAINT FK_SETOR 
FOREIGN KEY (CD_DEPARTAMENTO) REFERENCES TB_DEPARTAMENTO(CD_DEPARTAMENTO)

INSERT INTO TB_SETOR (CD_SETOR, NM_SETOR,NM_GERENTE, CD_DEPARTAMENTO)
VALUES (100,'SETOR 100','JOSE CARLOS',10)

INSERT INTO TB_SETOR (CD_SETOR, NM_SETOR, NM_GERENTE, CD_DEPARTAMENTO)
VALUES (200,'SETOR 200','JOSEFA', 20)

INSERT INTO TB_SETOR (CD_SETOR, NM_SETOR, NM_GERENTE, CD_DEPARTAMENTO)
VALUES (201,'SETOR 201','PAULO SILVA', 20)

INSERT INTO TB_SETOR (CD_SETOR, NM_SETOR, NM_GERENTE, CD_DEPARTAMENTO)
VALUES (202,'SETOR 202','RICARDO ARAUJO', 20)


CREATE TABLE TB_FUNCIONARIO (
  MATRICULA INT NOT NULL PRIMARY KEY,
  NM_FUNCIONARIO VARCHAR(40) NOT NULL,
  SEXO VARCHAR(1) NOT NULL,
  CD_SETOR INT NULL
)

ALTER TABLE TB_FUNCIONARIO ADD CONSTRAINT FK_FUNCIONARIO 
FOREIGN KEY (CD_SETOR) REFERENCES TB_SETOR(CD_SETOR)

INSERT INTO TB_FUNCIONARIO (MATRICULA, NM_FUNCIONARIO, SEXO, CD_SETOR)
VALUES (1,'JOAO','M',100)

INSERT INTO TB_FUNCIONARIO (MATRICULA, NM_FUNCIONARIO, SEXO, CD_SETOR)
VALUES (2,'MARIA','F',200)

INSERT INTO TB_FUNCIONARIO (MATRICULA, NM_FUNCIONARIO, SEXO, CD_SETOR)
VALUES (3,'PEDRO','M',200)

INSERT INTO TB_FUNCIONARIO (MATRICULA, NM_FUNCIONARIO, SEXO, CD_SETOR)
VALUES (4,'RICARDO','M',201)


--TABELA TECNICO
CREATE TABLE TB_TECNICO (
  CD_TECNICO INT NOT NULL PRIMARY KEY,
  NM_TECNICO VARCHAR(40) NOT NULL,
)

INSERT INTO TB_TECNICO (CD_TECNICO, NM_TECNICO)
VALUES (101,'RITA')

INSERT INTO TB_TECNICO (CD_TECNICO, NM_TECNICO)
VALUES (102,'PATRICIA')

INSERT INTO TB_TECNICO (CD_TECNICO, NM_TECNICO)
VALUES (103,'JOANA')

--TABELA SOLICITACAO
CREATE TABLE TB_SOLICITACAO (
  CD_SOLICITACAO INT NOT NULL PRIMARY KEY,
  MATRICULA INT NOT NULL,
  CD_TECNICO INT NULL,
  DATA_ABERTURA DATETIME NOT NULL,
  DESCRICAO VARCHAR(50) NOT NULL,
  DATA_FECHAMENTO DATETIME NULL,
  DESCRICAO_FECHAMENTO VARCHAR(50) NULL
)

ALTER TABLE TB_SOLICITACAO ADD CONSTRAINT FK_SOLICITACAO_FUNCIONARIO 
FOREIGN KEY (MATRICULA) REFERENCES TB_FUNCIONARIO(MATRICULA)

ALTER TABLE TB_SOLICITACAO ADD CONSTRAINT FK_SOLICITACAO_TECNICO 
FOREIGN KEY (CD_TECNICO) REFERENCES TB_TECNICO(CD_TECNICO)

INSERT INTO TB_SOLICITACAO (CD_SOLICITACAO, MATRICULA,CD_TECNICO,DATA_ABERTURA,
                            DESCRICAO, DATA_FECHAMENTO, DESCRICAO_FECHAMENTO)
VALUES(1, 1,101,'20190620','IMPRESSORA COM PROBLEMA',NULL, NULL)

INSERT INTO TB_SOLICITACAO (CD_SOLICITACAO, MATRICULA,CD_TECNICO,DATA_ABERTURA,
                            DESCRICAO, DATA_FECHAMENTO, DESCRICAO_FECHAMENTO)
VALUES(2, 2,101,'20190620','MS WORD COM PROBLEMA','20070620', 'REINSTALADO')

INSERT INTO TB_SOLICITACAO (CD_SOLICITACAO, MATRICULA,CD_TECNICO,DATA_ABERTURA,
                            DESCRICAO, DATA_FECHAMENTO, DESCRICAO_FECHAMENTO)
VALUES(3, 3,102,'20190620','MOUSE COM PROBLEMA',NULL, NULL)

INSERT INTO TB_SOLICITACAO (CD_SOLICITACAO, MATRICULA,CD_TECNICO,DATA_ABERTURA,
                            DESCRICAO, DATA_FECHAMENTO, DESCRICAO_FECHAMENTO)
VALUES(4, 4,102,'20190620','MONITOR COM PROBLEMA',NULL, NULL)

INSERT INTO TB_SOLICITACAO (CD_SOLICITACAO, MATRICULA,CD_TECNICO,DATA_ABERTURA,
                            DESCRICAO, DATA_FECHAMENTO, DESCRICAO_FECHAMENTO)
VALUES(5, 1,101,'20190622','MICRO TRAVANDO',NULL, NULL)

INSERT INTO TB_SOLICITACAO (CD_SOLICITACAO, MATRICULA,CD_TECNICO,DATA_ABERTURA,
                            DESCRICAO, DATA_FECHAMENTO, DESCRICAO_FECHAMENTO)
VALUES(6, 2,101,'20190622','MS EXCEL COM PROBLEMA',NULL, NULL)

-- letra a
SELECT * FROM TB_FUNCIONARIO F INNER JOIN TB_SOLICITACAO S
ON (F.MATRICULA = S.MATRICULA)
WHERE S.DATA_ABERTURA = '20190620'

SELECT * FROM TB_FUNCIONARIO F INNER JOIN TB_SOLICITACAO S
ON (F.MATRICULA = S.MATRICULA)
WHERE S.DATA_ABERTURA != '20190622'


WHERE  EXISTS (SELECT * FROM TB_FUNCIONARIO F INNER JOIN TB_SOLICITACAO S
							   ON (F.MATRICULA = S.MATRICULA)
							   WHERE S.DATA_ABERTURA = '20190620')
SELECT F.nm_funcionario FROM TB_FUNCIONARIO F
WHERE NOT EXISTS (SELECT F.nm_funcionario FROM TB_FUNCIONARIO F INNER JOIN TB_SOLICITACAO S
								 ON (F.MATRICULA = S.MATRICULA)
								 WHERE S.DATA_ABERTURA = '20190622')

WHERE (SELECT * FROM TB_SOLICITACAO S WHERE S.DATA_ABERTURA = '20190620')
AND NOT(SELECT * FROM TB_SOLICITACAO S WHERE DATA_ABERTURA = '20190622') 

-- letra b
SELECT F.matricula, F.nm_funcionario,
(SELECT COUNT(S.CD_SOLICITACAO) FROM TB_SOLICITACAO S
WHERE S.DATA_ABERTURA = '20190620') AS DIA20,
(SELECT COUNT(S.CD_SOLICITACAO) FROM TB_SOLICITACAO S
WHERE S.DATA_ABERTURA = '20190622') AS DIA22
FROM TB_FUNCIONARIO F

--letra c

	((SELECT F.nm_funcionario FROM TB_FUNCIONARIO F)
	UNION
	(SELECT T.nm_tecnico FROM TB_TECNICO T))
	
	
	SELECT ((SELECT F.nm_funcionario FROM TB_FUNCIONARIO F)
				UNION
			(SELECT T.nm_tecnico FROM TB_TECNICO T)) AS NM_FUNCIONARIO,
			SELECT
			COUNT(S.CD_SOLICITACAO) AS TOTAL
			FROM TB_SOLICITACAO S INNER JOIN TB_FUNCIONARIO F
			ON (S.MATRICULA = F.matricula)
				INNER JOIN TB_TECNICO T
				ON(T.CD_TECNICO = S.CD_TECNICO)
				GROUP BY S.CD_SOLICITACAO
				ORDER BY TOTAL DESC

			UNION
			INNER JOIN TB_TECNICO T
			ON(T.CD_TECNICO = S.CD_TECNICO)
			, COUNT(S.CD_SOLICITACAO)
FROM TB_FUNCIONARIO F INNER JOIN TB_SOLITACAO S
